<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>util/HTMLParser.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Clan.html">Clan</a></li><li><a href="Collection.html">Collection</a><ul class='methods'><li data-type='method'><a href="Collection.html#array">array</a></li><li data-type='method'><a href="Collection.html#clone">clone</a></li><li data-type='method'><a href="Collection.html#concat">concat</a></li><li data-type='method'><a href="Collection.html#deleteAll">deleteAll</a></li><li data-type='method'><a href="Collection.html#equals">equals</a></li><li data-type='method'><a href="Collection.html#every">every</a></li><li data-type='method'><a href="Collection.html#exists">exists</a></li><li data-type='method'><a href="Collection.html#filter">filter</a></li><li data-type='method'><a href="Collection.html#filterArray">filterArray</a></li><li data-type='method'><a href="Collection.html#find">find</a></li><li data-type='method'><a href="Collection.html#findAll">findAll</a></li><li data-type='method'><a href="Collection.html#first">first</a></li><li data-type='method'><a href="Collection.html#firstKey">firstKey</a></li><li data-type='method'><a href="Collection.html#keyArray">keyArray</a></li><li data-type='method'><a href="Collection.html#last">last</a></li><li data-type='method'><a href="Collection.html#lastKey">lastKey</a></li><li data-type='method'><a href="Collection.html#map">map</a></li><li data-type='method'><a href="Collection.html#random">random</a></li><li data-type='method'><a href="Collection.html#randomKey">randomKey</a></li><li data-type='method'><a href="Collection.html#reduce">reduce</a></li><li data-type='method'><a href="Collection.html#some">some</a></li><li data-type='method'><a href="Collection.html#sort">sort</a></li></ul></li><li><a href="HTMLParser.html">HTMLParser</a><ul class='methods'><li data-type='method'><a href="HTMLParser.html#parse">parse</a></li></ul></li><li><a href="ThunderAPI.html">ThunderAPI</a><ul class='methods'><li data-type='method'><a href="ThunderAPI.html#clearInterval">clearInterval</a></li><li data-type='method'><a href="ThunderAPI.html#clearTimeout">clearTimeout</a></li><li data-type='method'><a href="ThunderAPI.html#destroy">destroy</a></li><li data-type='method'><a href="ThunderAPI.html#getClan">getClan</a></li><li data-type='method'><a href="ThunderAPI.html#getNews">getNews</a></li><li data-type='method'><a href="ThunderAPI.html#getPlayer">getPlayer</a></li><li data-type='method'><a href="ThunderAPI.html#isPlayer">isPlayer</a></li><li data-type='method'><a href="ThunderAPI.html#searchWiki">searchWiki</a></li><li data-type='method'><a href="ThunderAPI.html#setInterval">setInterval</a></li><li data-type='method'><a href="ThunderAPI.html#setTimeout">setTimeout</a></li><li data-type='method'><a href="ThunderAPI.html#sweepCache">sweepCache</a></li></ul></li><li><a href="User.html">User</a></li></ul><h3>Externals</h3><ul><li><a href="external-Collection.html">Collection</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">util/HTMLParser.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { JSDOM } = require("jsdom");
const { TypeError, Error } = require("../errors");
const { URLs, EndPoints } = require("./Constants");
const cheerio = require("cheerio");

/**
 * Parses raw HTML to readable objects
 */
class HTMLParser {
  constructor(html, type) {
    /**
     * The HTML to be parsed
     * @type {string}
     */
    this.html = html;

    /**
     * The type to parse
     * @type {string}
     */
    this.type = type;
  }

  /**
   * Parses the HTML to a readable object
   * @return {PlayerData|SquadronData|NewsInfo[]|Wiki[]}
   */
  parse() {
    switch (this.type.toLowerCase()) {
      case EndPoints.user:
        return this.parseUser();
      case EndPoints.clan:
        return this.parseClan();
      case EndPoints.news:
        return this.parseNews();
      case EndPoints.wiki:
        return this.parseWiki();
    }
    throw new TypeError("INVALID_TYPE");
  }
  parseUser() { // eslint-disable-line complexity
    const $ = cheerio.load(this.html);

    if (!$(".user-profile__data-nick").length) throw new TypeError("USER_UNAVAILABLE");

    const info = $(".user-profile__data-item");
    const planes = $(".profile-score__list-col:nth-child(2) > .profile-score__list-item:not(:first-child)");
    const elite = $(".profile-score__list-col:nth-child(3) > .profile-score__list-item:not(:first-child)");
    const medals = $(".profile-score__list-col:nth-child(4) > .profile-score__list-item:not(:first-child)");
    /**
     * Represents the player's profile
     * @typedef {Object} ProfileInfo
     * @property {string} avatar The URL to the player's in-game avatar
     * @property {string} name The player's in-game name
     * @property {?string} title The player's title, if he has one
     * @property {?Clan} clan The player's squadron, if he's in one
     * @property {number} level The player's in-game experience level
     * @property {Date} registered The date when the player registered
     * @property {boolean} banned If the player's game access has been blocked
     * @property {CountryInfo} usa Statistics for the USA
     * @property {CountryInfo} ussr Statistics for the USSR
     * @property {CountryInfo} britain Statistics for Great Britain
     * @property {CountryInfo} germany Statistics for Germany
     * @property {CountryInfo} japan Statistics for Japan
     * @property {CountryInfo} italy Statistics for Italy
     * @property {CountryInfo} france Statistics for France
     */
    const profile = {
      name: $(".user-profile__data-nick").text().trim(),
      title: info.eq(0).text().length ? info.eq(0).text().trim() : null,
      clan: info.eq(2).length ? { tag: info.eq(1).text().trim(), url: $(".user-profile__data-link").attr("href") } : null,
      level: info.eq(2).length ? parseInt(info.eq(2).text().trim()
        .split(" ")[1])
        : parseInt(info.eq(1).text().trim()
          .split(" ")[1]),
      avatar: "http:".concat($(".user-profile__ava-img").attr("src")),
      registered: $(".user-profile__data-regdate")
        .text()
        .trim()
        .replace(/Registration date\s/, ""),
      banned: Boolean($(".user-profile__data-nick--banned").length),
      /**
       * Represents info about a nation for a player's profile
       * @typedef {Object} CountryInfo
       * @property {number} vehicles The amount of total vehicles
       * @property {number} elite The amount of elite (fully researched) vehicles
       * @property {number} medals The amount of medals for the country
       */
      usa: {
        vehicles: parseInt(planes.eq(0).text()),
        elite: parseInt(elite.eq(0).text()),
        medals: parseInt(medals.eq(0).text())
      },
      ussr: {
        vehicles: parseInt(planes.eq(1).text()),
        elite: parseInt(elite.eq(1).text()),
        medals: parseInt(medals.eq(1).text())
      },
      britain: {
        vehicles: parseInt(planes.eq(2).text()),
        elite: parseInt(elite.eq(2).text()),
        medals: parseInt(medals.eq(2).text())
      },
      germany: {
        vehicles: parseInt(planes.eq(3).text()),
        elite: parseInt(elite.eq(3).text()),
        medals: parseInt(medals.eq(3).text())
      },
      japan: {
        vehicles: parseInt(planes.eq(4).text()),
        elite: parseInt(elite.eq(4).text()),
        medals: parseInt(medals.eq(4).text())
      },
      italy: {
        vehicles: parseInt(planes.eq(5).text()),
        elite: parseInt(elite.eq(5).text()),
        medals: parseInt(medals.eq(5).text())
      },
      france: {
        vehicles: parseInt(planes.eq(6).text()),
        elite: parseInt(elite.eq(6).text()),
        medals: parseInt(medals.eq(6).text())
      }
    };

    const abdata = $(".profile-stat__list-ab > .profile-stat__list-item");
    const rbdata = $(".profile-stat__list-rb > .profile-stat__list-item");
    const sbdata = $(".profile-stat__list-sb > .profile-stat__list-item");

    /**
     * Represents player statistics
     * @typedef {Object} ProfileStats
     * @property {string} victories The amount of victories
     * @property {string} completed The amount of completed battles
     * @property {string} ratio The victory/battle ratio
     * @property {string} deaths The amount of deaths
     * @property {string} lionsEarned The amount of Silver Lions earnt
     * @property {string} playTime The time played
     * @property {string} airTargetsDestroyed The amount of air targets destroyed
     * @property {string} groundTargetsDestroyed The amount of ground targets destroyed
     * @property {string} navalTargetsDestroyed The amount of naval targets destroyed
     */
    const stats = {
      /**
       * Represents statistics per gamemode
       * @typedef {Object} DifficultyInfo
       * @property {ProfileStats} arcade The info for the Arcade gamemode
       * @property {ProfileStats} realistic The info for the Realistic gamemode
       * @property {ProfileStats} simulator The info for the Simulator gamemode
       */
      arcade: {
        victories: !isNaN(parseInt(abdata.eq(1).text().trim())) ? parseInt(abdata.eq(1).text().trim()) : null,
        completed: !isNaN(
          parseInt(abdata.eq(2)
            .text()
            .trim()
            .replace(/,/g, "")
          )
        ) ? parseInt(abdata.eq(2)
            .text()
            .trim()
            .replace(/,/g, "")
          ) : null,
        ratio: abdata.eq(3).text().trim(),
        deaths: !isNaN(
          parseInt(abdata.eq(4)
            .text()
            .trim()
            .replace(/,/g, "")
          )
        ) ? parseInt(abdata.eq(4)
            .text()
            .trim()
            .replace(/,/g, "")
          ) : null,
        lionsEarned: !isNaN(
          parseInt(abdata.eq(5)
            .text()
            .trim()
            .replace(/,/g, "")
          )
        ) ? parseInt(abdata.eq(5)
            .text()
            .trim()
            .replace(/,/g, "")
          ) : null,
        playTime: abdata.eq(6).text().trim(),
        airTargetsDestroyed: !isNaN(parseInt(abdata.eq(7).text().trim())) ? parseInt(abdata.eq(7).text().trim()) : null,
        groundTargetsDestroyed: !isNaN(parseInt(abdata.eq(8).text().trim())) ? parseInt(abdata.eq(8).text().trim()) : null,
        navalTargetsDestroyed: !isNaN(parseInt(abdata.eq(9).text().trim())) ? parseInt(abdata.eq(9).text().trim()) : null
      },
      realistic: {
        victories: !isNaN(parseInt(rbdata.eq(1).text().trim())) ? parseInt(rbdata.eq(1).text().trim()) : null,
        completed: !isNaN(
          parseInt(rbdata.eq(2)
            .text()
            .trim()
            .replace(/,/g, "")
          )
        ) ? parseInt(rbdata.eq(2)
            .text()
            .trim()
            .replace(/,/g, "")
          ) : null,
        ratio: rbdata.eq(3).text().trim(),
        deaths: !isNaN(
          parseInt(rbdata.eq(4)
            .text()
            .trim()
            .replace(/,/g, "")
          )
        ) ? parseInt(rbdata.eq(4)
            .text()
            .trim()
            .replace(/,/g, "")
          ) : null,
        lionsEarned: !isNaN(
          parseInt(rbdata.eq(5)
            .text()
            .trim()
            .replace(/,/g, "")
          )
        ) ? parseInt(rbdata.eq(5)
            .text()
            .trim()
            .replace(/,/g, "")
          ) : null,
        playTime: rbdata.eq(6).text().trim(),
        airTargetsDestroyed: !isNaN(parseInt(rbdata.eq(7).text().trim())) ? parseInt(rbdata.eq(7).text().trim()) : null,
        groundTargetsDestroyed: !isNaN(parseInt(rbdata.eq(8).text().trim())) ? parseInt(rbdata.eq(8).text().trim()) : null,
        navalTargetsDestroyed: !isNaN(parseInt(rbdata.eq(9).text().trim())) ? parseInt(rbdata.eq(9).text().trim()) : null
      },
      simulator: {
        victories: !isNaN(parseInt(sbdata.eq(1).text().trim())) ? parseInt(sbdata.eq(1).text().trim()) : null,
        completed: !isNaN(
          parseInt(sbdata.eq(2)
            .text()
            .trim()
            .replace(/,/g, "")
          )
        ) ? parseInt(sbdata.eq(2)
            .text()
            .trim()
            .replace(/,/g, "")
          ) : null,
        ratio: sbdata.eq(3).text().trim(),
        deaths: !isNaN(
          parseInt(sbdata.eq(4)
            .text()
            .trim()
            .replace(/,/g, "")
          )
        ) ? parseInt(sbdata.eq(4)
            .text()
            .trim()
            .replace(/,/g, "")
          ) : null,
        lionsEarned: !isNaN(
          parseInt(sbdata.eq(5)
            .text()
            .trim()
            .replace(/,/g, "")
          )
        ) ? parseInt(sbdata.eq(5)
            .text()
            .trim()
            .replace(/,/g, "")
          ) : null,
        playTime: sbdata.eq(6).text().trim(),
        airTargetsDestroyed: !isNaN(parseInt(sbdata.eq(7).text().trim())) ? parseInt(sbdata.eq(7).text().trim()) : null,
        groundTargetsDestroyed: !isNaN(parseInt(sbdata.eq(8).text().trim())) ? parseInt(sbdata.eq(8).text().trim()) : null,
        navalTargetsDestroyed: !isNaN(parseInt(sbdata.eq(9).text().trim())) ? parseInt(sbdata.eq(9).text().trim()) : null
      }
    };

    /**
     * Represents raw data about a player
     * @typedef {Object} PlayerData
     * @property {ProfileInfo} profile The player's profile
     * @property {ProfileStats} stats Game statistics for the player
     */
    return {
      profile,
      stats
    };
  }

  parseClan() {
    const { window: { document } } = new JSDOM(this.html);

    const claninfo = document.getElementsByClassName("clan-info")[0];
    const clanmembers = document.getElementsByClassName("clan-members")[0];

    if (!claninfo) {
      throw new TypeError("NOT_FOUND", "clan");
    }

    const members = [];
    for (const member of clanmembers.children[0].children) {
      if (member.children.length !== 7) {
        continue;
      }
      /**
       * Represents info about a clan member
       * @typedef {Object} SquadronMemberInfo
       * @property {string} name The in-game name of the squadron member
       * @property {SquadronDifficultyStats} rating The rating for the squadron member, per difficulty
       * @property {string} role The squadron member's role
       * @property {string} entry The date of entry for the squadron member
       */
      const obj = {
        name: member.children[1].children[0].textContent,
        rating: {
          arcade: member.children[2].textContent,
          realistic: member.children[3].textContent,
          simulator: member.children[4].textContent
        },
        role: member.children[5].textContent !== "" ? member.children[5].textContent : "Unknown",
        entry: member.children[6].textContent
      };
      members.push(obj);
    }

    /**
     * Represents raw clan data
     * @typedef {Object} SquadronData
     * @property {string} name The squadron name
     * @property {string} image The URL to the squadron's in-game picture
     * @property {number} players The amount of players in the squadron
     * @property {string} description The squadron's description
     * @property {string} createdAt The date of creation for the squadron
     * @property {SquadronDifficultyStats} airKills The amount of air targets destroyed per difficulty
     * @property {SquadronDifficultyStats} groundKills The amount of ground targets destroyed per difficulty
     * @property {SquadronDifficultyStats} deaths The amount of deaths per difficulty
     * @property {SquadronDifficultyStats} flightTime The total flight time per difficulty
     * @property {SquadronMemberInfo[]} members Info for each squadron member
     */
    const data = {
      name: claninfo.children[0].children[0].children[0].children[0].children[1].textContent.split(" ").slice(1).join(" "),
      tag: claninfo.children[0].children[0].children[0].children[0].children[1].textContent.split("]")[0].slice(1),
      image: claninfo.children[0].children[0].children[0].children[0].children[0].src.split(URLs.static).join(""),
      players: parseInt(claninfo.children[0].children[0].children[0].children[0].children[2].textContent
        .replace("Number of players:", "")
        .split("&lt;br>").join("")
        .trim()),
      description: claninfo.children[0].children[0].children[0].children[0].children[3].textContent,
      createdAt: claninfo.children[0].children[0].children[0].children[0].children[4].textContent
        .replace("date of creation:", "")
        .trim(),
      /**
       * Represents info per difficulty for a clan.
       * This is identical to {@link Profile#difficultyInfo}, with the difference being
       * that Profile#difficultyInfo is for profile statistics (which are objects),
       * and {@link Clan#SquadronDifficultyStats} is for strings.
       * @typedef {Object} SquadronDifficultyStats
       * @property {string} arcade The info for the Arcade gamemode
       * @property {string} realistic The info for the Realistic gamemode
       * @property {string} simulator The info for the Simulator gamemode
       */
      airKills: {
        arcade: claninfo.children[0].children[3].children[1].textContent,
        realistic: claninfo.children[0].children[5].children[1].textContent,
        simulator: claninfo.children[0].children[7].children[1].textContent
      },
      groundKills: {
        arcade: claninfo.children[0].children[3].children[2].textContent,
        realistic: claninfo.children[0].children[5].children[2].textContent,
        simulator: claninfo.children[0].children[7].children[2].textContent
      },
      deaths: {
        arcade: claninfo.children[0].children[3].children[3].textContent,
        realistic: claninfo.children[0].children[5].children[3].textContent,
        simulator: claninfo.children[0].children[7].children[3].textContent
      },
      flightTime: {
        arcade: claninfo.children[0].children[3].children[4].textContent,
        realistic: claninfo.children[0].children[5].children[4].textContent,
        simulator: claninfo.children[0].children[7].children[4].textContent
      },
      members
    };

    return data;
  }

  parseNews() {
    const { window: { document } } = new JSDOM(this.html);

    const elements = document.getElementsByClassName("news_item");

    if (!elements.length) throw new Error("NOT_FOUND", "news");
    const data = [];
    for (const element of elements) {
      /**
       * Represents a War Thunder news item
       * @typedef {Object} NewsInfo
       * @property {string} url The URL to the news/changelog page
       * @property {string} title The title of the news/update
       * @property {string} date The date the news was announced/the update was released
       */
      const item = {
        url: element.children[1].children[0].href,
        title: element.children[1].children[0].textContent.split("  ").join(" "),
        // eslint-disable-next-line max-len
        date: element.children[0].textContent
      };
      data.push(item);
    }

    return data;
  }

  parseWiki() {
    const { window: { document } } = new JSDOM(this.html);

    if (document.getElementsByClassName("mw-search-nonefound").length) throw new Error("NOT_FOUND", "wiki");

    const results = document.getElementsByClassName("mw-search-results")[0].children;
    const data = [];
    const main = document.getElementsByClassName("mw-search-createlink")[0];
    if (main.textContent.trim() !== "") {
      const arr = main.innerHTML
        .split("&lt;b>")
        .join("")
        .split("&lt;/b>")
        .join("")
        .split("\"\"")
        .join("");
      const title = arr.split(">")[1].split("&lt;")[0].trim();
      const obj = {
        title,
        url: `${URLs.wiki}${main.children[0].children[0].href}`,
        main: true
      };
      data.push(obj);
    }
    for (const result of results) {
      /**
       * Represents a War Thunder Wiki search result
       * @typedef {Object} wiki
       * @property {string} title The title of the search result's page
       * @property {string} url The URL to the search result's page
       * @property {Boolean} main If there is a page named as the search query on the Wiki
       */
      const obj = {
        title: result.children[0].children[0].textContent,
        url: `${URLs.wiki}${result.children[0].children[0].href}`,
        main: false
      };
      if (data[0] &amp;&amp; data[0].title === obj.title) continue;
      data.push(obj);
    }
    return data;
  }
}

module.exports = HTMLParser;</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
